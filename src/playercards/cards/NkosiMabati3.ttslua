require("playercards/CardsWithHelper")

-- intentionally global
hasXML                     = false
isHelperEnabled            = false

local chaosBagApi = require("chaosbag/ChaosBagApi")

-- XML background color for each token
local tokenColor  = {
  ["Skull"] = "#4A0400E6",
  ["Cultist"] = "#173B0BE6",
  ["Tablet"] = "#1D2238E6",
  ["Elder Thing"] = "#4D2331E6",
  ["Auto-fail"] = "#9B0004E6",
  ["Bless"] = "#9D702CE6",
  ["Curse"] = "#633A84E6",
  ["Frost"] = "#404450E6",
  [""] = "#77674DE6"
}

function updateSave()
  self.script_state = JSON.encode({
    isHelperEnabled = isHelperEnabled,
    sigil = sigil
  })
end

function onLoad(savedData)
  syncDisplayWithOptionPanel()
  if savedData and savedData ~= "" then
    local loadedData = JSON.decode(savedData)
    isHelperEnabled = loadedData.isHelperEnabled
    sigil = loadedData.sigil
    makeXMLButton()
    self.clearContextMenu()
    self.addContextMenuItem("Clear Helper", toggleHelper)
  end
end

function makeXMLButton()
  -- get name of the icon for the sigil ("token" + lowercase name without space characters)
  local sigilName = Global.call("getReadableTokenName", sigil)
  local iconName = "token-" .. string.lower(sigilName)
  iconName = iconName:gsub("%s", "-")

  self.UI.setXmlTable({
    {
      tag = "Button",
      attributes = {
        height = 450,
        width = 1400,
        rotation = "0 0 180",
        scale = "0.1 0.1 1",
        position = "0 -55 -22",
        padding = "50 50 50 50",
        font = "font_teutonic-arkham",
        fontSize = 300,
        iconWidth = "400",
        iconAlignment = "Right",
        onClick = "resolveSigil",
        icon = iconName,
        color = tokenColor[sigil],
        textColor = "White"
      },
      value = "Resolve"
    }
  }
  )
end

-- Create XML button to prompt choosing a sigil; acts as this card's helper
function initialize()
  self.UI.setXmlTable({
    {
      tag = "Button",
      attributes = {
        height = 450,
        width = 1400,
        rotation = "0 0 180",
        scale = "0.1 0.1 1",
        position = "0 -55 -22",
        padding = "50 50 50 50",
        font = "font_teutonic-arkham",
        fontSize = 300,
        onClick = "chooseSigil",
        color = "#77674DE6",
        textColor = "White"
      },
      value = "Choose Sigil"
    }
  }
  )
end

-- Create dialog window to choose sigil and create sigil-drawing button
function chooseSigil(player)
  player.clearSelectedObjects()
  self.clearContextMenu()
  self.addContextMenuItem("Clear Helper", toggleHelper)

  -- get list of readable names
  local readableNames = {}
  for token, _ in pairs(tokenColor) do
    table.insert(readableNames, Global.call("getReadableTokenName", token))
  end

  -- prompt player to choose sigil
  player.showOptionsDialog("Choose Sigil", readableNames, 1,
    function(chosenToken)
      sigil = Global.call("getChaosTokenName", chosenToken)
      makeXMLButton()
    end
  )
end

function shutOff()
  self.UI.setXml("")
  sigil = nil
end

function resolveSigil()
  local match = false
  for _, obj in ipairs(chaosBagApi.findChaosBag().getObjects()) do
    -- if there are any sigils in the bag
    if obj.nickname == sigil then
      match = true
      break
    end
  end

  if not match then
    broadcastToAll(Global.call("getReadableTokenName", sigil) .. " not found in chaos bag", "Red")
    return
  end

  Global.call("activeRedrawEffect", {
    DRAW_SPECIFIC_TOKEN = sigil,
    VALID_TOKENS = {
      ["Tablet"] = true,
      ["Elder Thing"] = true,
      ["Cultist"] = true
    }
  })
end
